<script>
import __AdvancedSelectElement from '@lotsof/advanced-select-element';
// @ts-ignore
import { __idCompliant } from '@lotsof/sugar/string';
import { __toSlug } from '@lotsof/website-common/src/components/utils/utils';
import { navigate } from 'astro:transitions/client';

  let cachedItems: any[];

  document.addEventListener('sAdvancedSelect.select', (e) => {
    const item = (e as CustomEvent).detail.item;
    if (item.slug) {
      navigate(item.slug);
    } else {
      navigate(`/doc/${__toSlug(item.value)}`);
    }
  });

  const $loSearch = document.querySelector('lo-search') as HTMLElement;
  document.addEventListener('keydown', () => {
    if (document.activeElement?.tagName === 'INPUT') {
      return;
    }
    $loSearch?.focus();
  })

  __AdvancedSelectElement.define('lo-search', {
    async items() {
      if (cachedItems) {
        return cachedItems;
      }

      const request = await fetch('/api/doc'),
        data = await request.json();

      const sections: Record<string, any> = {};

      data.forEach((item: any) => {
        let platforms = [];
        try {
          platforms = JSON.parse(item.data.platform);
        } catch (e) {}
        // @ts-ignore
        platforms = platforms.map((p: string) => p.name.toLowerCase());

        const group = item.data.namespace.split('.')[3];

        if (!sections[group]) {
          sections[group] = {
            type: 'group',
            label: group,
            items: [],
          };
        }

        sections[group].items.push({
          id: __idCompliant(item.id),
          label: `${item.data.title}`,
          value: `${item.id.replace(/\//gm, '.').replace(/\.mdx$/, '')}`,
          preventSet: true
        });
      });

      cachedItems = [
        {
          type: 'group',
          label: 'Documentation',
          items: [
            {
              id: 'install',
              label: 'Get started',
              value: 'install',
              slug: '/',
              preventSet: true,
            },
            {
              id: 'vite',
              label: 'Use with vite',
              value: 'vite',
              slug: '/doc/vite',
              preventSet: true,
            },
            {
              id: 'settings',
              label: 'Settings',
              value: 'settings',
              slug: '/doc/settings',
              preventSet: true,
            },
            {
              id: 'mixins',
              label: 'Mixins',
              value: 'mixins',
              slug: '/doc/mixins',
              preventSet: true,
            },
            {
              id: 'grids',
              label: 'Grids',
              value: 'grids',
              slug: '/doc/grids',
              preventSet: true,
            },
          ],
        },
        ...Object.values(sections),
      ];
      return cachedItems;
    },
  });
  
</script>

<form class="search">
  <lo-search inline>
    <input type="search" class="_input" placeholder="Search" />
  </lo-search>
</form>
